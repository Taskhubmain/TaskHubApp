# Быстрый старт - Тестирование платежей

## Обзор

После оплаты через Stripe Checkout происходит **редирект на веб-страницу кошелька**.

## Как это работает

### Из мобильного приложения:

1. Пользователь нажимает **"Пополнить"** в приложении
2. Открывается **браузер** со Stripe Checkout
3. После оплаты → **редирект на веб-сайт** `https://your-domain.com/#/wallet?deposit=success`
4. Пользователь видит **страницу кошелька в браузере** с уведомлением

### Из веб-версии:

1. Пользователь нажимает **"Пополнить"** на сайте
2. Редирект на **Stripe Checkout** (в том же окне/вкладке)
3. После оплаты → **возврат на страницу кошелька** `/#/wallet?deposit=success`
4. Показывается уведомление об успешном пополнении

## Тестирование

### 1. Запустите приложение

```bash
npm run build
npx cap sync android
npx cap open android
```

В Android Studio нажмите Run ▶️

### 2. Перейдите в "Кошелек"

- В приложении откройте раздел "Кошелек"
- Нажмите кнопку **"Пополнить"**

### 3. Введите сумму

- Введите сумму, например `10`
- Нажмите **"Продолжить"**

### 4. Оплатите в браузере

Откроется браузер со Stripe Checkout:

**Тестовая карта:**
- Номер: `4242 4242 4242 4242`
- Срок: любая будущая дата (например, `12/34`)
- CVC: любые 3 цифры (например, `123`)
- ZIP: любой (например, `12345`)

Нажмите **"Pay"**

### 5. Проверьте результат

После успешной оплаты:

1. **Вы останетесь в браузере**
2. Браузер откроет **веб-страницу кошелька** на вашем сайте
3. URL будет: `https://your-domain.com/#/wallet?deposit=success`
4. На странице **появится уведомление** "Пополнение успешно"
5. **Баланс обновится** автоматически

### 6. Вернитесь в приложение (опционально)

Вы можете:
- Продолжить работу в браузере на веб-версии
- Или вернуться в приложение вручную (свернуть браузер)

## Тестирование отмены платежа

### 1. Нажмите "Пополнить"

В приложении или на сайте

### 2. В Stripe Checkout нажмите "Back" или закройте страницу

### 3. Результат:

- Редирект на: `https://your-domain.com/#/wallet?deposit=cancelled`
- Уведомление: **"Платёж отменён"**
- Баланс **не изменится**

## Переменные окружения

Убедитесь, что в Supabase Dashboard для функции `create-wallet-topup-session` настроены:

- `STRIPE_SECRET_KEY` = ваш Stripe Secret Key (`sk_test_...`)
- `STRIPE_PUBLISHABLE_KEY` = ваш Stripe Publishable Key (`pk_test_...`)
- `FRONTEND_URL` = URL вашего сайта (например, `https://rpbdamgcikqdmptficsc.supabase.co`)

## URL редиректов

Edge function автоматически генерирует URL'ы:

```typescript
const successUrl = `${frontendUrl}/#/wallet?deposit=success`;
const cancelUrl = `${frontendUrl}/#/wallet?deposit=cancelled`;
```

**Пример:**
- Success: `https://rpbdamgcikqdmptficsc.supabase.co/#/wallet?deposit=success`
- Cancel: `https://rpbdamgcikqdmptficsc.supabase.co/#/wallet?deposit=cancelled`

## Обработка результата на странице

Файл: `src/pages/WalletPage.tsx`

```typescript
const urlParams = new URLSearchParams(window.location.hash.split('?')[1] || '');
const depositStatus = urlParams.get('deposit');

if (depositStatus === 'success') {
  // Показать уведомление "Пополнение успешно"
  // Обновить баланс
  // Очистить параметры из URL
}
```

## Отладка

### Проверьте FRONTEND_URL

В Supabase Dashboard:
- Перейдите в **Edge Functions**
- Откройте функцию `create-wallet-topup-session`
- Проверьте переменную `FRONTEND_URL`

### Проверьте логи Edge Function

```bash
# В консоли Supabase
supabase functions logs create-wallet-topup-session
```

Должны увидеть:
```
Success URL: https://your-domain.com/#/wallet?deposit=success
Cancel URL: https://your-domain.com/#/wallet?deposit=cancelled
```

### Проверьте редирект в браузере

После нажатия "Pay" в Stripe Checkout, проверьте URL в адресной строке:

✅ **Правильно:**
```
https://your-domain.com/#/wallet?deposit=success
```

❌ **Неправильно (если забыли настроить FRONTEND_URL):**
```
https://rpbdamgcikqdmptficsc.supabase.co/#/wallet?deposit=success
```

## Преимущества этого подхода

1. ✅ **Простота** - не нужны deep links
2. ✅ **Универсальность** - работает одинаково в приложении и на сайте
3. ✅ **Надёжность** - редирект через URL всегда работает
4. ✅ **Безопасность** - карточные данные не проходят через приложение
5. ✅ **PCI Compliance** - Stripe полностью управляет процессом оплаты

## Важные моменты

### ❗ Пользователь остаётся в браузере

После оплаты пользователь **НЕ** вернётся автоматически в приложение. Он увидит **веб-версию страницы кошелька**.

### ❗ Работает для всех платформ

- **Android app** → браузер → веб-страница кошелька
- **iOS app** → браузер → веб-страница кошелька
- **Web** → Stripe → возврат на веб-страницу кошелька

### ❗ Требуется авторизация

После редиректа пользователь должен быть авторизован на веб-версии сайта, иначе он не увидит свой баланс.

**Решение:** Используйте Supabase Auth с shared session между мобильным приложением и веб-версией.

## FAQ

### Q: Почему пользователь не возвращается в приложение?

**A:** Потому что Stripe делает HTTP редирект на веб-URL. Мобильное приложение не может перехватить этот редирект.

### Q: Как сделать, чтобы приложение открывалось автоматически?

**A:** Нужно использовать deep links (например, `taskhub://wallet?deposit=success`). Но для этого требуется:
1. Настроить deep links в AndroidManifest
2. Зарегистрировать схему в системе
3. Обработать deep link в приложении

Текущая реализация использует простой редирект на веб-страницу.

### Q: Пользователь увидит два окна (браузер + приложение)?

**A:** Да. После оплаты:
1. Браузер остаётся открытым с веб-страницей кошелька
2. Приложение остаётся в фоне

Пользователь может:
- Продолжить работу в браузере (веб-версия)
- Или свернуть браузер и вернуться в приложение

### Q: Можно ли сделать лучше?

**A:** Да, несколько вариантов:

**Вариант 1: Custom Tabs (Android)**
- Показывать Stripe Checkout в Custom Tabs (overlay)
- После оплаты закрывать Custom Tabs
- Пользователь остаётся в приложении

**Вариант 2: Deep Links**
- Использовать схему `taskhub://`
- Приложение открывается автоматически после оплаты
- Требует дополнительной настройки

**Вариант 3: WebView**
- Показывать Stripe Checkout внутри приложения
- Не рекомендуется (проблемы с 3D Secure и PCI)

Текущая реализация - самая простая и надёжная.
